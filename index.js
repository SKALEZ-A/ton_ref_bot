
// const { Telegraf } = require("telegraf");
// const axios = require("axios");
// const path = require("path");

// const bot = new Telegraf("6809279648:AAH9CZQIpgeVKZWhg3o2zVv0awic9ArJW7Q");

// const imagePath = (fileName) => path.join(__dirname, "images", fileName);

// const registerUser = async (userId, username, inviterUsername = "") => {
//   try {
//     const response = await axios.post("https://walledb.onrender.com/api/Cluster0/register", {
//       userId,
//       inviterUsername,
//       username,
//     });
//     return response.data;
//   } catch (error) {
//     console.error('Error registering user:', error.response.data);
//     throw error;
//   }
// };

// bot.start(async (ctx) => {
//   const userId = ctx.from.id;
//   const username = ctx.from.username || `user${userId}`;
//   let inviterUsername = "";

//   if (ctx.message && ctx.message.text) {
//     const parts = ctx.message.text.split(' ');
//     if (parts.length > 1) {
//       inviterUsername = parts[1]; // The second part is the inviter's username
//     }
//   }

//   try {
//     await registerUser(userId, username, inviterUsername);
//     ctx.replyWithPhoto(
//       { source: imagePath("description.jpg") },
//       {
//         caption: `*Welcome, @${username}! to Ton Diamond ðŸ’Ž*\n\nYou are now a Builder on Ton Blockchain and can be entitled to revenues generated by *Ton DiamondðŸ’ŽðŸ’Ž!!*`,
//         parse_mode: 'Markdown',
//         reply_markup: {
//           inline_keyboard: [
//             [
//               {
//                 text: "Play",
//                 web_app: { url: "https://walle-bot.vercel.app/" },
//               },
//               { text: "Join community", callback_data: "join_community" },
//             ],
//           ],
//         },
//       }
//     );
//   } catch (error) {
//     ctx.reply('Welcome Back!');
//   }
// });

// bot.launch();
const { Telegraf } = require("telegraf");
const axios = require("axios");
const path = require("path");

const bot = new Telegraf("6809279648:AAH9CZQIpgeVKZWhg3o2zVv0awic9ArJW7Q");

const imagePath = (fileName) => path.join(__dirname, "images", fileName);

const registerUser = async (userId, username, inviterUsername = "") => {
  try {
    const response = await axios.post("https://walledb.onrender.com/api/Cluster0/register", {
      userId,
      inviterUsername,
      username,
    });
    return response.data;
  } catch (error) {
    console.error('Error registering user:', error.response?.data || error.message);
    throw error;
  }
};

bot.start(async (ctx) => {
  const userId = ctx.from.id;
  const username = ctx.from.username || `user${userId}`;
  let inviterUsername = "";

  if (ctx.payload) {
    inviterUsername = ctx.payload;
  } else if (ctx.message && ctx.message.text) {
    const parts = ctx.message.text.split(' ');
    if (parts.length > 1) {
      inviterUsername = parts[1]; // The second part is the inviter's username
    }
  }

  console.log(`Inviter Username: ${inviterUsername}`); // Log the inviterUsername for debugging

  try {
    await registerUser(userId, username, inviterUsername);
    ctx.replyWithPhoto(
      { source: imagePath("description.jpg") },
      {
        caption: `*Welcome, @${username}! to Ton Diamond ðŸ’Ž*\n\nYou are now a Builder on Ton Blockchain and can be entitled to revenues generated by *Ton DiamondðŸ’ŽðŸ’Ž!!*`,
        parse_mode: 'Markdown',
        reply_markup: {
          inline_keyboard: [
            [
              {
                text: "Play",
                web_app: { url: "https://walle-bot.vercel.app/" },
              },
              { text: "Join community", callback_data: "join_community" },
            ],
          ],
        },
      }
    );
  } catch (error) {
    ctx.reply('Welcome Back!');
  }
});

bot.launch();
